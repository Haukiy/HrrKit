name: HRR Intake (Issues)

on:
  issues:
    types: [labeled]           # run only when a label is added
  issue_comment:
    types: [created]           # allow /validate or /intake-commit re-runs
  workflow_dispatch:           # manual run from Actions UI
    inputs:
      mode:
        description: "Run mode: validation or process"
        required: false
        default: validation

permissions:
  contents: write
  issues: write

jobs:
  run:
    # Run when:
    #  - issue is labeled 'hrr-intake'
    #  - someone comments '/process' or '/intake-commit'
    #  - manual dispatch
    if: >
      (github.event_name == 'issues' &&
       github.event.action == 'labeled' &&
       contains(join(github.event.issue.labels.*.name, ','), 'hrr-intake')) ||
      (github.event_name == 'issue_comment' && (
         startsWith(github.event.comment.body, '/process') ||
         startsWith(github.event.comment.body, '/validate') ||
         startsWith(github.event.comment.body, '/intake-commit')
      )) ||
      (github.event_name == 'workflow_dispatch')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Debug event
        run: |
          echo "event:  ${{ github.event_name }}"
          echo "action: ${{ github.event.action }}"
          echo "labels: ${{ join(github.event.issue.labels.*.name, ',') }}"
          echo "title:  ${{ github.event.issue.title }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas matplotlib requests

      - name: Extract issue payload
        id: payload
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput('number', String(issue.number));
            core.setOutput('title', issue.title ?? '');
            core.setOutput('body', issue.body ?? '');
            core.setOutput('labels', (issue.labels ?? []).map(l => l.name).join(','));

      - name: Determine run mode
        id: mode
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            let mode = 'validation';
            if (event === 'issue_comment') {
              const body = (context.payload.comment?.body || '').trim();
              if (body.startsWith('/intake-commit')) {
                mode = 'process';
              } else {
                mode = 'validation';
              }
            } else if (event === 'workflow_dispatch') {
              const inputMode = (core.getInput('mode') || 'validation').trim().toLowerCase();
              if (inputMode === 'process') {
                mode = 'process';
              }
            }
            core.setOutput('mode', mode);

      - name: Require successful validation label before processing
        if: ${{ steps.mode.outputs.mode == 'process' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number('${{ steps.payload.outputs.number }}');
            const labelName = 'hrr-validated';
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            const hasLabel = (issue.labels || []).some(label => label.name === labelName);
            if (!hasLabel) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '⚠️ Validation has not passed yet. Comment **`/validate`** to run Phase 1 before requesting `/intake-commit`. '
              });
              core.setFailed(`Issue #${issueNumber} is missing the '${labelName}' label.`);
            }

      - name: Prepare raw_files, parse CSV from issue, pull files (attachments or inline), update database.csv
        env:
          ISSUE_BODY: ${{ steps.payload.outputs.body }}
          ISSUE_NUMBER: ${{ steps.payload.outputs.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          HRR_EVENT_NAME: ${{ github.event_name }}
        run: |
          set -e
          mkdir -p raw_files
          if [ "$HRR_EVENT_NAME" = "workflow_dispatch" ]; then
            python issue_intake.py --database database.csv --raw-dir raw_files
          else
            python issue_intake.py --database database.csv --raw-dir raw_files --require-body
          fi

      - name: Run HRR validation
        if: ${{ steps.mode.outputs.mode == 'validation' }}
        id: validation_run
        continue-on-error: true
        run: |
          python - << 'PY'
          import os, subprocess, sys
          import matplotlib; matplotlib.use("Agg")
          script = (
            'hrr_chat.py' if os.path.exists('hrr_chat.py')
            else ('hrrkit_excel.py' if os.path.exists('hrrkit_excel.py') else None)
          )
          if not script:
            print("Error: neither hrr_chat.py nor hrrkit_excel.py found", file=sys.stderr)
            sys.exit(1)
          sys.exit(subprocess.call([sys.executable, script,
            "--database","database.csv","--raw","raw_files","--base","hrr_database",
            "--quantile","0.90","--validate-only","--validation-report","validation_report.json"]))
          PY

      - name: Summarize validation results
        if: ${{ steps.mode.outputs.mode == 'validation' }}
        id: validation_summary
        run: |
          python - <<'PY'
          import json, os
          from pathlib import Path

          report_path = Path('validation_report.json')
          lines = ['### HRR validation report']
          status = 'error'
          if not report_path.exists():
              lines.append('')
              lines.append('_Validator did not produce a report._')
          else:
              data = json.loads(report_path.read_text())
              status = data.get('overall_status', 'error')
              rows = data.get('rows') or []
              lines.append('')
              lines.append(f"*Overall status:* **{status.upper()}**")
              if not rows:
                  lines.append('')
                  lines.append('No pending rows were found in database.csv.')
              else:
                  for row in rows:
                      indicator = '✅' if row.get('status') == 'ok' else '❌'
                      rid = str(row.get('id') or row.get('row_index'))
                      topic = row.get('topic') or '(topic missing)'
                      lines.append('')
                      lines.append(f"{indicator} Row ID {rid} ({topic})")
                      errors = row.get('errors') or []
                      warnings = row.get('warnings') or []
                      for err in errors:
                          lines.append(f"    - {err}")
                      for warn in warnings:
                          lines.append(f"    - warning: {warn}")

          summary = '\n'.join(lines).strip() + '\n'
          Path('validation_summary.md').write_text(summary, encoding='utf-8')
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"status={status}\n")
              fh.write("summary<<EOF\n")
              fh.write(summary)
              fh.write("EOF\n")
          PY

      - name: Update validation label
        if: ${{ steps.mode.outputs.mode == 'validation' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number('${{ steps.payload.outputs.number }}');
            const status = '${{ steps.validation_summary.outputs.status }}';
            const labelName = 'hrr-validated';
            if (status === 'success') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [labelName],
              });
            } else {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: labelName,
                });
              } catch (error) {
                // ignore if label absent
              }
            }

      - name: Comment validation result
        if: ${{ steps.mode.outputs.mode == 'validation' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issueNumber = Number('${{ steps.payload.outputs.number }}');
            const status = '${{ steps.validation_summary.outputs.status }}';
            let summary = 'Validation summary unavailable.\n';
            try {
              summary = fs.readFileSync('validation_summary.md', 'utf-8');
            } catch (error) {
              // keep fallback summary
            }
            const nextStep = status === 'success'
              ? '\n\n✅ Validation passed. Comment **`/intake-commit`** to run Phase 2 (processing + commit).'
              : '\n\nPlease address the issues above, then comment **`/validate`** to rerun Phase 1.';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: summary + nextStep,
            });

      - name: Run HRR processor
        if: ${{ steps.mode.outputs.mode == 'process' }}
        id: process_run
        run: |
          python - << 'PY'
          import os, subprocess, sys
          import matplotlib; matplotlib.use("Agg")
          script = (
            'hrr_chat.py' if os.path.exists('hrr_chat.py')
            else ('hrrkit_excel.py' if os.path.exists('hrrkit_excel.py') else None)
          )
          if not script:
            print("Error: neither hrr_chat.py nor hrrkit_excel.py found", file=sys.stderr)
            sys.exit(1)
          sys.exit(subprocess.call([sys.executable, script,
            "--database","database.csv","--raw","raw_files","--base","hrr_database","--quantile","0.90"]))
          PY

      - name: Ensure output dir for artifact
        if: ${{ steps.mode.outputs.mode == 'process' }}
        run: mkdir -p hrr_database

      - name: Upload outputs (artifact)
        if: ${{ steps.mode.outputs.mode == 'process' }}
        uses: actions/upload-artifact@v4
        with:
          name: hrr-outputs-issue-${{ steps.payload.outputs.number }}
          path: |
            hrr_database/**
            database.csv
          if-no-files-found: warn
          retention-days: 10

      - name: Commit changes (processing phase)
        if: ${{ steps.mode.outputs.mode == 'process' }}
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "HRR intake (issue #${{ steps.payload.outputs.number }}): processed inputs [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Clear validation label after processing
        if: ${{ always() && steps.mode.outputs.mode == 'process' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number('${{ steps.payload.outputs.number }}');
            const labelName = 'hrr-validated';
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: labelName,
              });
            } catch (error) {
              // ignore
            }

      - name: Comment processing result
        if: ${{ always() && steps.mode.outputs.mode == 'process' }}
        uses: actions/github-script@v7
        with:
          script: |
            const num = Number('${{ steps.payload.outputs.number }}');
            const artifactName = `hrr-outputs-issue-${num}`;
            const succeeded = '${{ steps.process_run.outcome }}' === 'success';
            const lines = [];
            if (succeeded) {
              lines.push('✅ HRR processing (Phase 2) completed.');
              lines.push('');
              lines.push(`- Artifact: **${artifactName}**`);
              lines.push('- Results were committed to the repository.');
              lines.push('');
              lines.push('Need to ingest more data? Update the issue and rerun Phase 1 with **`/validate`**.');
            } else {
              lines.push('❌ HRR processing (Phase 2) failed.');
              lines.push('');
              lines.push('Check the workflow logs for details, address the problem, then rerun Phase 1 with **`/validate`**.');
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: num,
              body: lines.join('\n'),
            });
